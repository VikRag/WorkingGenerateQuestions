<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äì Learning Academy</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f6fa;
    --surface: #ffffff;
    --surface2: #f0f1f7;
    --border: #e4e6f0;
    --text: #1a1d2e;
    --text-muted: #7b7f96;
    --primary: #4f6ef7;
    --primary-light: #eef1fe;
    --green: #22c55e;
    --green-light: #dcfce7;
    --red: #ef4444;
    --red-light: #fee2e2;
    --amber: #f59e0b;
    --amber-light: #fef3c7;
    --radius: 14px;
    --shadow: 0 2px 12px rgba(0,0,0,0.07);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0 0 60px;
  }

  /* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
  .topnav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 50;
    box-shadow: 0 1px 8px rgba(0,0,0,0.05);
  }

  .nav-left { display: flex; align-items: center; gap: 12px; }

  .logo-chip {
    font-size: 1em; font-weight: 800;
    color: var(--primary);
    display: flex; align-items: center; gap: 6px;
  }

  .nav-divider { width: 1px; height: 20px; background: var(--border); }

  .nav-title {
    font-size: 0.9em; font-weight: 600;
    color: var(--text-muted);
  }

  .nav-right { display: flex; align-items: center; gap: 10px; }

  .user-chip {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 12px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 99px;
    font-size: 0.85em; font-weight: 600;
    color: var(--text);
  }

  .user-avatar {
    width: 26px; height: 26px;
    background: var(--primary);
    border-radius: 99px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75em; font-weight: 800;
    color: white;
    flex-shrink: 0;
  }

  .btn-signout {
    padding: 7px 14px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: inherit; font-size: 0.82em; font-weight: 600;
    color: var(--text-muted); cursor: pointer;
    transition: all 0.15s;
  }
  .btn-signout:hover { border-color: var(--red); color: var(--red); }

  .btn-quiz {
    padding: 8px 16px;
    background: var(--primary);
    border: none; border-radius: 8px;
    font-family: inherit; font-size: 0.85em; font-weight: 700;
    color: white; cursor: pointer; transition: all 0.15s;
    text-decoration: none;
    display: inline-flex; align-items: center; gap: 5px;
  }
  .btn-quiz:hover { background: #3d5ce5; transform: translateY(-1px); }

  /* ‚îÄ‚îÄ PAGE BODY ‚îÄ‚îÄ */
  .page {
    max-width: 860px;
    margin: 0 auto;
    padding: 36px 24px 0;
  }

  /* ‚îÄ‚îÄ LOADING / AUTH GATE ‚îÄ‚îÄ */
  .loading-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 60vh; gap: 12px; color: var(--text-muted);
  }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 99px;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ WELCOME HEADER ‚îÄ‚îÄ */
  .welcome-header {
    margin-bottom: 28px;
  }
  .welcome-header h1 {
    font-size: 1.7em; font-weight: 800;
    letter-spacing: -0.02em;
    margin-bottom: 4px;
  }
  .welcome-header p { font-size: 0.9em; color: var(--text-muted); }

  /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px 18px;
    display: flex; flex-direction: column; gap: 6px;
  }

  .stat-card .label {
    font-size: 0.74em; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted);
  }

  .stat-card .value {
    font-size: 2em; font-weight: 800;
    font-family: 'DM Mono', monospace;
    line-height: 1;
  }

  .stat-card .sub-label {
    font-size: 0.78em; font-weight: 500;
    color: var(--text-muted);
  }

  .v-blue   { color: var(--primary); }
  .v-green  { color: var(--green); }
  .v-amber  { color: var(--amber); }
  .v-red    { color: var(--red); }

  /* ‚îÄ‚îÄ TWO COLUMN ‚îÄ‚îÄ */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-bottom: 28px;
  }

  /* ‚îÄ‚îÄ CARD SECTION ‚îÄ‚îÄ */
  .section-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .section-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .section-head h2 {
    font-size: 0.95em; font-weight: 700;
    display: flex; align-items: center; gap: 7px;
  }

  .section-body { padding: 18px 20px; }

  /* ‚îÄ‚îÄ SUBJECT BARS ‚îÄ‚îÄ */
  .subject-bar { margin-bottom: 14px; }
  .subject-bar:last-child { margin-bottom: 0; }

  .subject-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 5px;
  }

  .subject-name { font-size: 0.875em; font-weight: 600; }
  .subject-pct  { font-family: 'DM Mono', monospace; font-size: 0.82em; font-weight: 600; color: var(--text-muted); }

  .bar-track {
    height: 7px; background: var(--surface2);
    border-radius: 99px; overflow: hidden;
  }
  .bar-fill {
    height: 100%; border-radius: 99px;
    background: var(--primary);
    transition: width 1s cubic-bezier(.4,0,.2,1);
  }

  /* ‚îÄ‚îÄ RECENT QUIZZES TABLE ‚îÄ‚îÄ */
  .quiz-table { width: 100%; border-collapse: collapse; }

  .quiz-table th {
    font-size: 0.72em; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted);
    padding: 0 12px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .quiz-table td {
    padding: 12px;
    font-size: 0.875em; font-weight: 500;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .quiz-table tr:last-child td { border-bottom: none; }

  .quiz-table tr:hover td { background: var(--surface2); }

  .pct-badge {
    display: inline-flex; align-items: center;
    padding: 3px 10px; border-radius: 99px;
    font-family: 'DM Mono', monospace;
    font-size: 0.82em; font-weight: 700;
  }
  .pct-great  { background: var(--green-light);  color: var(--green); }
  .pct-ok     { background: var(--amber-light);  color: var(--amber); }
  .pct-low    { background: var(--red-light);    color: var(--red); }
  .pct-pass   { background: var(--primary-light);color: var(--primary); }

  .subject-pill {
    display: inline-flex;
    padding: 2px 9px; border-radius: 99px;
    font-size: 0.78em; font-weight: 700;
    background: var(--primary-light); color: var(--primary);
  }

  .empty-state {
    padding: 36px 20px; text-align: center;
    color: var(--text-muted); font-size: 0.9em;
  }
  .empty-state .icon { font-size: 2em; margin-bottom: 8px; }

  /* ‚îÄ‚îÄ RECENT ACTIVITY FEED ‚îÄ‚îÄ */
  .activity-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
  }
  .activity-item:last-child { border-bottom: none; padding-bottom: 0; }
  .activity-icon {
    width: 34px; height: 34px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1em; flex-shrink: 0;
  }
  .activity-icon.green { background: var(--green-light); }
  .activity-icon.blue  { background: var(--primary-light); }
  .activity-icon.amber { background: var(--amber-light); }
  .activity-text { flex: 1; }
  .activity-text .title { font-size: 0.875em; font-weight: 600; margin-bottom: 2px; }
  .activity-text .meta  { font-size: 0.78em; color: var(--text-muted); }
  .activity-time { font-size: 0.75em; color: var(--text-muted); font-family: 'DM Mono', monospace; white-space: nowrap; }

  /* ‚îÄ‚îÄ FULL HISTORY TABLE (wide) ‚îÄ‚îÄ */
  .full-section { margin-bottom: 28px; }

  @media(max-width: 700px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .two-col   { grid-template-columns: 1fr; }
    .topnav    { padding: 0 16px; }
    .page      { padding: 24px 14px 0; }
    .nav-title { display: none; }
  }

  @media(max-width: 420px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .user-chip .user-name { display: none; }
  }
</style>
</head>
<body>

<!-- Top Nav -->
<nav class="topnav">
  <div class="nav-left">
    <div class="logo-chip">üéì Learning Academy</div>
    <div class="nav-divider"></div>
    <span class="nav-title">Dashboard</span>
  </div>
  <div class="nav-right">
    <div class="user-chip">
      <div class="user-avatar" id="avatarInitial">?</div>
      <span class="user-name" id="navUserName">Loading...</span>
    </div>
    <a href="quiz.html" class="btn-quiz">‚úèÔ∏è Take Quiz</a>
    <button class="btn-signout" onclick="signOutUser()">Sign Out</button>
  </div>
</nav>

<!-- Page -->
<div class="page" id="mainPage" style="display:none">

  <!-- Welcome -->
  <div class="welcome-header">
    <h1 id="welcomeHeading">Welcome back! üëã</h1>
    <p id="welcomeSub">Here's how you're doing across all your quizzes.</p>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="label">Quizzes Taken</div>
      <div class="value v-blue" id="statTotal">0</div>
      <div class="sub-label">all time</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg Score</div>
      <div class="value v-green" id="statAvg">‚Äî</div>
      <div class="sub-label">across all quizzes</div>
    </div>
    <div class="stat-card">
      <div class="label">Best Score</div>
      <div class="value v-amber" id="statBest">‚Äî</div>
      <div class="sub-label">personal best</div>
    </div>
    <div class="stat-card">
      <div class="label">Questions Right</div>
      <div class="value v-primary" id="statCorrect" style="color:var(--primary)">0</div>
      <div class="sub-label">total correct answers</div>
    </div>
  </div>

  <!-- Two-col: Subject breakdown + Activity -->
  <div class="two-col">

    <!-- Subject breakdown -->
    <div class="section-card">
      <div class="section-head">
        <h2>üìö By Subject</h2>
      </div>
      <div class="section-body" id="subjectBreakdown">
        <div class="empty-state"><div class="icon">üìä</div>No data yet</div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="section-card">
      <div class="section-head">
        <h2>‚ö° Recent Activity</h2>
      </div>
      <div class="section-body" id="recentActivity">
        <div class="empty-state"><div class="icon">üïê</div>No recent activity</div>
      </div>
    </div>

  </div>

  <!-- Full Quiz History -->
  <div class="full-section">
    <div class="section-card">
      <div class="section-head">
        <h2>üìã Quiz History</h2>
        <span style="font-size:0.78em;color:var(--text-muted);font-weight:600;" id="historyCount"></span>
      </div>
      <div id="historyTableWrap">
        <div class="empty-state"><div class="icon">üìù</div>No quizzes taken yet ‚Äî <a href="quiz.html" style="color:var(--primary);font-weight:600;">take your first quiz!</a></div>
      </div>
    </div>
  </div>

</div>

<!-- Loading screen -->
<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <span>Loading your dashboard...</span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCcIgbm_Qk3w60r6F-Yo-vgUOvp28KBDis",
  authDomain: "learning-academy-1063f.firebaseapp.com",
  projectId: "learning-academy-1063f",
  storageBucket: "learning-academy-1063f.firebasestorage.app",
  messagingSenderId: "388313798196",
  appId: "1:388313798196:web:23de2662c83deae6d25c61"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* Sign out */
window.signOutUser = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};

/* Auth gate */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // Display name: use displayName if set, otherwise derive from email
  const rawName = user.displayName || user.email.split("@")[0];
  const name = rawName.charAt(0).toUpperCase() + rawName.slice(1);
  const initial = name.charAt(0).toUpperCase();

  document.getElementById("navUserName").textContent = name;
  document.getElementById("avatarInitial").textContent = initial;
  document.getElementById("welcomeHeading").textContent = `Welcome back, ${name}! üëã`;

  // Load quiz results
  try {
    const q = query(
      collection(db, "users", user.uid, "quizResults"),
      orderBy("timestamp", "desc")
    );
    const snap = await getDocs(q);
    const results = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderDashboard(results);
  } catch (e) {
    console.error("Error loading results:", e);
    renderDashboard([]);
  }

  document.getElementById("loadingScreen").style.display = "none";
  document.getElementById("mainPage").style.display = "block";
});

/* ‚îÄ‚îÄ Render everything ‚îÄ‚îÄ */
function renderDashboard(results) {
  if (results.length === 0) return; // leave empty states

  /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
  const total    = results.length;
  const avgScore = Math.round(results.reduce((s, r) => s + (r.percentage || 0), 0) / total);
  const best     = Math.max(...results.map(r => r.percentage || 0));
  const totalCorrect = results.reduce((s, r) => s + (r.score || 0), 0);

  document.getElementById("statTotal").textContent   = total;
  document.getElementById("statAvg").textContent     = avgScore + "%";
  document.getElementById("statBest").textContent    = best + "%";
  document.getElementById("statCorrect").textContent = totalCorrect;

  /* ‚îÄ‚îÄ Subject breakdown ‚îÄ‚îÄ */
  const bySubject = {};
  results.forEach(r => {
    const s = r.subject || "Unknown";
    if (!bySubject[s]) bySubject[s] = { total: 0, sumPct: 0, count: 0 };
    bySubject[s].count++;
    bySubject[s].sumPct += (r.percentage || 0);
  });

  const subjectColors = { Math: "#4f6ef7", Science: "#22c55e", Social: "#f59e0b", English: "#ef4444", Unknown: "#7b7f96" };

  const subjectHTML = Object.entries(bySubject).map(([name, d]) => {
    const avg = Math.round(d.sumPct / d.count);
    const color = subjectColors[name] || "#4f6ef7";
    return `
      <div class="subject-bar">
        <div class="subject-row">
          <span class="subject-name">${name}</span>
          <span class="subject-pct">${avg}% ¬∑ ${d.count} quiz${d.count !== 1 ? 'zes' : ''}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="width:0%;background:${color}" data-target="${avg}"></div>
        </div>
      </div>`;
  }).join('');

  document.getElementById("subjectBreakdown").innerHTML = subjectHTML || '<div class="empty-state"><div class="icon">üìä</div>No data yet</div>';

  // Animate bars after render
  requestAnimationFrame(() => setTimeout(() => {
    document.querySelectorAll(".bar-fill[data-target]").forEach(el => {
      el.style.width = el.dataset.target + "%";
    });
  }, 100));

  /* ‚îÄ‚îÄ Recent Activity (last 5) ‚îÄ‚îÄ */
  const recent = results.slice(0, 5);
  const activityHTML = recent.map(r => {
    const pct = r.percentage || 0;
    const icon = pct >= 70 ? "üèÜ" : pct >= 50 ? "‚úÖ" : "üìù";
    const iconClass = pct >= 70 ? "green" : pct >= 50 ? "blue" : "amber";
    const timeStr = r.timestamp ? formatTime(r.timestamp.toDate ? r.timestamp.toDate() : new Date(r.timestamp)) : "‚Äî";
    return `
      <div class="activity-item">
        <div class="activity-icon ${iconClass}">${icon}</div>
        <div class="activity-text">
          <div class="title">${r.subject || "Quiz"} ¬∑ Grade ${r.grade || "?"}</div>
          <div class="meta">${r.score || 0} / ${r.total || "?"} correct ¬∑ ${pct}%</div>
        </div>
        <div class="activity-time">${timeStr}</div>
      </div>`;
  }).join('');

  document.getElementById("recentActivity").innerHTML = activityHTML || '<div class="empty-state"><div class="icon">üïê</div>No recent activity</div>';

  /* ‚îÄ‚îÄ Full history table ‚îÄ‚îÄ */
  document.getElementById("historyCount").textContent = `${total} total`;

  const rows = results.map((r, i) => {
    const pct = r.percentage || 0;
    const badgeCls = pct >= 90 ? "pct-great" : pct >= 70 ? "pct-pass" : pct >= 50 ? "pct-ok" : "pct-low";
    const timeStr = r.timestamp ? (r.timestamp.toDate ? r.timestamp.toDate() : new Date(r.timestamp)).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "‚Äî";
    return `
      <tr>
        <td style="color:var(--text-muted);font-family:'DM Mono',monospace;font-size:0.78em;">#${total - i}</td>
        <td><span class="subject-pill">${r.subject || "‚Äî"}</span></td>
        <td>Grade ${r.grade || "‚Äî"}</td>
        <td>${r.score || 0} / ${r.total || "‚Äî"}</td>
        <td><span class="pct-badge ${badgeCls}">${pct}%</span></td>
        <td style="color:var(--text-muted);font-size:0.82em;">${timeStr}</td>
      </tr>`;
  }).join('');

  document.getElementById("historyTableWrap").innerHTML = `
    <table class="quiz-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Subject</th>
          <th>Grade</th>
          <th>Score</th>
          <th>Percentage</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ‚îÄ‚îÄ Time formatter ‚îÄ‚îÄ */
function formatTime(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);
  if (diff < 60)   return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + "m ago";
  if (diff < 86400)return Math.floor(diff / 3600) + "h ago";
  if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
}
</script>
</body>
</html>
